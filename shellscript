#!/bin/bash

input_file="input.csv"
output_file="output.csv"
timestamp=$(date '+%Y-%m-%d %H:%M:%S')

echo "TimeStamp,ServerName,ServerStatus,ServerStatusCode,CMDBAppName,APMNumber,ApplicationName,RecoveryGroup,SubDivision,RTO" > "$output_file"

tail -n +2 "$input_file" | while IFS=, read -r ServerName ServerIPAddress AssertType CMDBAppName APMNumber RecoveryGroup SubDivision RTO ITDepartment number CMDBPrefix AppServiceName DNSDomain RecoveryStartupPriority OSVersion InTestScope
do
    if [[ "${AssertType,,}" == *"linux"* ]]; then
        nc_output=$(nc -zv -w1 "$ServerIPAddress" 22 2>&1)
        if [[ $nc_output == *"refused"* ]]; then
            server_status="DOWN"
        elif [[ $nc_output == *"Connected"* ]]; then
            server_status="UP"
        else
            server_status="DOWN"
        fi
    else
        nc_output=$(nc -zv -w1 "$ServerIPAddress" 3389 2>&1)
        if [[ $nc_output == *"refused"* ]]; then
            server_status="DOWN"
        elif [[ $nc_output == *"Connected"* ]]; then
            server_status="UP"
        else
            server_status="DOWN"
        fi
    fi
    
    ping -c1 -W1 "$ServerIPAddress" >/dev/null 2>&1
    ping_status=$?
    
    if [ $ping_status -eq 0 ]; then
        status_code="1"
    else
        status_code="0"
    fi
    
    if [[ "$SubDivision" == "FAS Technology" ]]; then
        rto="0-6 Hours"
    else
        rto="6-24 Hours"
    fi
    
    echo "$timestamp,$ServerName,$server_status,$status_code,$CMDBAppName,$APMNumber,$AppServiceName,$RecoveryGroup,$SubDivision,$rto" >> "$output_file"
done
