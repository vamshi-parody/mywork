#!/bin/bash

# Check dependencies
for cmd in nc ping awk; do
    if ! command -v $cmd &> /dev/null; then
        echo "Error: $cmd is not installed"
        exit 1
    fi
done

linux_vms_file="linux_vms.csv"
windows_vms_file="windows_vms.csv"
linux_output="linux_port_scan_results.csv"
windows_output="windows_port_scan_results.csv"

check_ping() {
    local ip=$1
    ping -c 1 -W 2 $ip >/dev/null 2>&1
    if [ $? -eq 0 ]; then
        echo "UP"
    else
        echo "DOWN"
    fi
}

check_port() {
    local hostname=$1
    local ip=$2
    local port=$3
    local os_type=$4
    local output_file=$5
    local ping_status=$6
    local result
    local status
    local timestamp=$(date '+%Y-%m-%d %H:%M:%S')

    result=$(nc -vz -w 3 $ip $port 2>&1)
    exit_code=$?

    if [[ $os_type == "Linux" ]]; then
        if [[ $result == *"succeeded"* ]] || [[ $result == *"Connected"* ]]; then
            status="OPEN"
        else
            status="CLOSED"
        fi
    else  # Windows
        if [[ $result == *"refused"* ]] || [ $exit_code -eq 0 ]; then
            status="OPEN"
        else
            status="CLOSED"
        fi
    fi
    echo "$hostname,$ip,$port,$status,$ping_status,$timestamp" >> "$output_file"
}

init_output_file() {
    local output_file=$1
    echo "Hostname,IP Address,Port,Status,Ping Status,Timestamp" > "$output_file"
}

echo "Starting scan..."

init_output_file "$linux_output"
init_output_file "$windows_output"

# Process Linux VMs - Port 22 only
awk -F',' 'NR>1 {
    gsub(/"/, "", $1);
    gsub(/"/, "", $2);
    if ($1 != "" && $2 != "") print $1","$2
}' "$linux_vms_file" | while IFS=',' read -r hostname ip; do
    echo "Checking Linux VM: $hostname ($ip)..."
    ping_status=$(check_ping "$ip")
    check_port "$hostname" "$ip" 22 "Linux" "$linux_output" "$ping_status"
done

# Process Windows VMs - Port 3889 only
awk -F',' 'NR>1 {
    gsub(/"/, "", $1);
    gsub(/"/, "", $2);
    if ($1 != "" && $2 != "") print $1","$2
}' "$windows_vms_file" | while IFS=',' read -r hostname ip; do
    echo "Checking Windows VM: $hostname ($ip)..."
    ping_status=$(check_ping "$ip")
    check_port "$hostname" "$ip" 3889 "Windows" "$windows_output" "$ping_status"
done

echo "Scan complete."
