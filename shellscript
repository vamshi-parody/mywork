#!/bin/bash

# Check dependencies
for cmd in nc ping awk; do
    if ! command -v $cmd &> /dev/null; then
        echo "Error: $cmd is not installed"
        exit 1
    fi
done

input_file="input.csv"
output_file="server_status.csv"

check_ping() {
    local ip=$1
    ping -c 1 -W 2 $ip >/dev/null 2>&1
    if [ $? -eq 0 ]; then
        echo "UP"
    else
        echo "DOWN"
    fi
}

check_port() {
    local ip=$1
    local port=$2
    local result
    
    result=$(nc -vz -w 3 $ip $port 2>&1)
    exit_code=$?

    if [ $port -eq 3889 ]; then
        if [[ $result == *"refused"* ]] || [ $exit_code -eq 0 ]; then
            echo "OPEN"
        else
            echo "CLOSED"
        fi
    else
        if [[ $result == *"succeeded"* ]] || [[ $result == *"Connected"* ]]; then
            echo "OPEN"
        else
            echo "CLOSED"
        fi
    fi
}

# Initialize output file
echo "timestamp,servername,servicestatus,serverstatuscode,cmdbapp,apmnumber,applicationname,recoverygroup,subdivision,rto,It department" > "$output_file"

# Process all servers from input file
awk -F',' 'NR>1 {
    gsub(/"/, "");
    if ($1 != "" && $2 != "") {
        # Map column positions based on input CSV structure
        server=$1;
        ip=$2;
        type=$3;
        cmdbapp=$4;
        apm=$5;
        recgroup=$6;
        subdiv=$7;
        rto=$7;  # Extract RTO from subdivisionrto if needed
        appname=$10;
        
        # Check if server type contains "linux" or "windows" (case-insensitive)
        if (tolower(type) ~ /linux/) {
            port=22;
        } else if (tolower(type) ~ /windows/) {
            port=3889;
        } else {
            next;  # Skip if type is neither
        }
        
        print server","ip","port","type","cmdbapp","apm","appname","recgroup","subdiv","rto
    }
}' "$input_file" | while IFS=',' read -r server ip port type cmdbapp apm appname recgroup subdiv rto; do
    echo "Checking $server ($ip)"
    timestamp=$(date '+%Y-%m-%d %H:%M:%S')
    ping_status=$(check_ping "$ip")
    service_status=$(check_port "$ip" "$port")
    
    echo "$timestamp,$server,$service_status,$ping_status,$cmdbapp,$apm,$appname,$recgroup,$subdiv,$rto,IT" >> "$output_file"
done

echo "Scan complete. Results saved to $output_file"
