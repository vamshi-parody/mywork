#!/bin/bash

# Check for nc
if ! command -v nc &> /dev/null; then
    echo "Error: netcat (nc) is not installed"
    exit 1
fi

# Files
linux_vms_file="linux_vms.txt"
windows_vms_file="windows_vms.txt"
linux_output="linux_port_scan_results.txt"
windows_output="windows_port_scan_results.txt"

# Check input files
if [ ! -f "$linux_vms_file" ] || [ ! -f "$windows_vms_file" ]; then
    echo "Error: VM list files not found"
    exit 1
fi

timeout=3

check_port() {
    local host=$1
    local port=$2
    local os_type=$3
    local output_file=$4
    local result
    local exit_code

    result=$(nc -vz -w $timeout $host $port 2>&1)
    exit_code=$?

    if [[ $os_type == "Linux" ]]; then
        if [[ $result == *"succeeded"* ]] || [[ $result == *"Connected"* ]]; then
            echo "[$os_type] $host:$port - OPEN" >> "$output_file"
        else
            echo "[$os_type] $host:$port - CLOSED" >> "$output_file"
        fi
    else  # Windows
        if [ $exit_code -eq 0 ]; then
            echo "[$os_type] $host:$port - OPEN" >> "$output_file"
        else
            echo "[$os_type] $host:$port - CLOSED" >> "$output_file"
        fi
    fi
}

init_output_file() {
    local output_file=$1
    local os_type=$2
    > "$output_file"
    echo "$os_type VM Port Scan Results - $(date)" >> "$output_file"
    echo "=================================" >> "$output_file"
}

echo "Starting scan..."

# Initialize outputs
init_output_file "$linux_output" "Linux"
init_output_file "$windows_output" "Windows"

# Linux VMs
while IFS= read -r vm || [ -n "$vm" ]; do
    [[ -z "$vm" || "$vm" =~ ^[[:space:]]*# ]] && continue
    echo "Checking Linux VM: $vm..."
    echo -e "\nChecking $vm:" >> "$linux_output"
    check_port "$vm" 22 "Linux" "$linux_output"
    check_port "$vm" 389 "Linux" "$linux_output"
    echo "---" >> "$linux_output"
done < "$linux_vms_file"

# Windows VMs
while IFS= read -r vm || [ -n "$vm" ]; do
    [[ -z "$vm" || "$vm" =~ ^[[:space:]]*# ]] && continue
    echo "Checking Windows VM: $vm..."
    echo -e "\nChecking $vm:" >> "$windows_output"
    check_port "$vm" 22 "Windows" "$windows_output"
    check_port "$vm" 389 "Windows" "$windows_output"
    echo "---" >> "$windows_output"
done < "$windows_vms_file"

echo "Scan complete."
echo "Linux results: $linux_output"
echo "Windows results: $windows_output"

# Show results
echo -e "\nLinux VM Results:"
cat "$linux_output"
echo -e "\nWindows VM Results:"
cat "$windows_output"
