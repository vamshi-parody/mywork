#!/bin/bash

# Input and output file paths
INPUT_FILE="input.csv"
OUTPUT_FILE="output.csv"

# Ensure the output file has a header
echo "TimeStamp,ServerName,ServerStatus,ServerStatusCode,CMDBAppName,APMNumber,ApplicationName,RecoveryGroup,SubDivision,RTO" > "$OUTPUT_FILE"

# Skip the header of the input CSV file
tail -n +2 "$INPUT_FILE" | while IFS=',' read -r ServerName ServerIPAddress AssertType CMDBAppName APMNumber RecoveryGroup SubDivision RTO _; do
    # Determine port based on AssertType
    if [[ "$AssertType" =~ [Ll]inux ]]; then
        PORT=22
    elif [[ "$AssertType" =~ [Ww]indows ]]; then
        PORT=3389
    else
        continue # Skip if AssertType is neither Linux nor Windows
    fi

    # Check server status (nc for port and ping for connectivity)
    nc -z -w 5 "$ServerIPAddress" "$PORT" &>/dev/null
    ServerStatus=$([[ $? -eq 0 ]] && echo "Up" || echo "Down")

    ping -c 1 -W 5 "$ServerIPAddress" &>/dev/null
    ServerStatusCode=$([[ $? -eq 0 ]] && echo "1" || echo "0")

    # Timestamp
    TimeStamp=$(date '+%Y-%m-%d %H:%M:%S')

    # Write output to the CSV
    echo "$TimeStamp,$ServerName,$ServerStatus,$ServerStatusCode,$CMDBAppName,$APMNumber,$ServerName,$RecoveryGroup,$SubDivision,$RTO" >> "$OUTPUT_FILE"
done

echo "Processing complete. Output written to $OUTPUT_FILE"
